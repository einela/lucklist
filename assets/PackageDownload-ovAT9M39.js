import{cJ as e,B as t,o as r,j as a,k as n,D as o,ah as s,c0 as i,ab as l,R as c,ag as d,G as m,J as u,K as h,S as p,l as g,y as w,z as f,A as v,_ as y}from"./index-C_g2pi0Z.js";class b{constructor(){this.crc=-1}append(e){for(var t=0|this.crc,r=this.table,a=0,n=0|e.length;a<n;a++)t=t>>>8^r[255&(t^e[a])];this.crc=t}get(){return~this.crc}}b.prototype.table=(()=>{var e,t,r,a=[];for(e=0;e<256;e++){for(r=e,t=0;t<8;t++)r=1&r?r>>>1^3988292384:r>>>1;a[e]=r}return a})();const S=e=>{var t=new Uint8Array(e);return{array:t,view:new DataView(t.buffer)}};window.ZIP=function(e){function t(){m++,l=n[o[m]],l?a():c&&r()}function r(){var e,t,r=0,a=0;for(e=0;e<o.length;e++)r+=46+(t=n[o[e]]).nameBuf.length+t.comment.length;const s=S(r+22);for(e=0;e<o.length;e++)t=n[o[e]],s.view.setUint32(a,1347092738),s.view.setUint16(a+4,5120),s.array.set(t.header.array,a+6),s.view.setUint16(a+32,t.comment.length,!0),t.directory&&s.view.setUint8(a+38,16),s.view.setUint32(a+42,t.offset,!0),s.array.set(t.nameBuf,a+46),s.array.set(t.comment,a+46+t.nameBuf.length),a+=46+t.nameBuf.length+t.comment.length;s.view.setUint32(a,1347093766),s.view.setUint16(a+8,o.length,!0),s.view.setUint16(a+10,o.length,!0),s.view.setUint32(a+12,r,!0),s.view.setUint32(a+16,d,!0),i.enqueue(s.array),i.close()}function a(){var e;if(l)return l.directory?l.writeFooter(l.writeHeader()):l.reader?(e=l).reader.read().then(t=>{if(t.done)return e.writeFooter();const r=t.value;e.crc.append(r),e.uncompressedLength+=r.length,e.compressedLength+=r.length,e.ctrl.enqueue(r)}):void(l.fileLike.stream?(l.crc=new b,l.reader=l.fileLike.stream.getReader(),l.writeHeader()):t())}const n=Object.create(null),o=[],s=new TextEncoder;let i,l,c,d=0,m=0;var u={enqueue(e){if(c)throw new TypeError("Cannot enqueue a chunk into a readable stream that is closed or has been requested to be closed");let r=e.name.trim();const m=new Date(void 0===e.lastModified?Date.now():e.lastModified);if(e.directory&&!r.endsWith("/")&&(r+="/"),n[r])throw new Error("File already exists.");const u=s.encode(r);o.push(r);const h=n[r]={level:0,ctrl:i,directory:!!e.directory,nameBuf:u,comment:s.encode(e.comment||""),compressedLength:0,uncompressedLength:0,writeHeader(){var e=S(26),t=S(30+u.length);h.offset=d,h.header=e,0===h.level||h.directory||e.view.setUint16(4,2048),e.view.setUint32(0,335546376),e.view.setUint16(6,(m.getHours()<<6|m.getMinutes())<<5|m.getSeconds()/2,!0),e.view.setUint16(8,(m.getFullYear()-1980<<4|m.getMonth()+1)<<5|m.getDate(),!0),e.view.setUint16(22,u.length,!0),t.view.setUint32(0,1347093252),t.array.set(e.array,4),t.array.set(u,30),d+=t.array.length,i.enqueue(t.array)},writeFooter(){var e=S(16);e.view.setUint32(0,1347094280),h.crc&&(h.header.view.setUint32(10,h.crc.get(),!0),h.header.view.setUint32(14,h.compressedLength,!0),h.header.view.setUint32(18,h.uncompressedLength,!0),e.view.setUint32(4,h.crc.get(),!0),e.view.setUint32(8,h.compressedLength,!0),e.view.setUint32(12,h.uncompressedLength,!0)),i.enqueue(e.array),d+=h.compressedLength+16,t()},fileLike:e};l||(l=h,a())},close(){if(c)throw new TypeError("Cannot close a readable stream that has already been requested to be closed");l||r(),c=!0}};return new ReadableStream({start:t=>{i=t,e.start&&Promise.resolve(e.start(u))},pull:()=>a()||e.pull&&Promise.resolve(e.pull(u))})};var U,L={exports:{}};const E=e((U||(U=1,function(){L.exports=(()=>{function e(e){if(!e)throw new Error("meh");const t=document.createElement("iframe");return t.hidden=!0,t.src=e,t.loaded=!1,t.name="iframe",t.isIframe=!0,t.postMessage=(...e)=>t.contentWindow.postMessage(...e),t.addEventListener("load",()=>{t.loaded=!0},{once:!0}),document.body.appendChild(t),t}const t="object"==typeof window?window:this;t.HTMLElement||console.warn("streamsaver is meant to run on browsers main thread");let r=null,a=!1;const n=t.WebStreamsPolyfill||{},o=t.isSecureContext;let s=/constructor/i.test(t.HTMLElement)||!!t.safari||!!t.WebKitPoint;const i=o||"MozAppearance"in document.documentElement.style?"iframe":"navigate",l={createWriteStream:function(n,c,d){let m={size:null,pathname:null,writableStrategy:void 0,readableStrategy:void 0},u=0,h=null,p=null,g=null;if(Number.isFinite(c)?([d,c]=[c,d],console.warn("[StreamSaver] Deprecated pass an object as 2nd argument when creating a write stream"),m.size=d,m.writableStrategy=c):c&&c.highWaterMark?(console.warn("[StreamSaver] Deprecated pass an object as 2nd argument when creating a write stream"),m.size=d,m.writableStrategy=c):m=c||{},!s){r||(r=o?e(l.mitm):function(e){const r=document.createDocumentFragment(),a={frame:t.open(e,"popup","width=200,height=100"),loaded:!1,isIframe:!1,isPopup:!0,remove(){a.frame.close()},addEventListener(...e){r.addEventListener(...e)},dispatchEvent(...e){r.dispatchEvent(...e)},removeEventListener(...e){r.removeEventListener(...e)},postMessage(...e){a.frame.postMessage(...e)}},n=e=>{e.source===a.frame&&(a.loaded=!0,t.removeEventListener("message",n),a.dispatchEvent(new Event("load")))};return t.addEventListener("message",n),a}(l.mitm)),p=new MessageChannel,n=encodeURIComponent(n.replace(/\//g,":")).replace(/['()]/g,escape).replace(/\*/g,"%2A");const s={transferringReadable:a,pathname:m.pathname||Math.random().toString().slice(-6)+"/"+n,headers:{"Content-Type":"application/octet-stream; charset=utf-8","Content-Disposition":"attachment; filename*=UTF-8''"+n}};m.size&&(s.headers["Content-Length"]=m.size);const c=[s,"*",[p.port2]];if(a){const e="iframe"===i?void 0:{transform(e,t){if(!(e instanceof Uint8Array))throw new TypeError("Can only write Uint8Arrays");u+=e.length,t.enqueue(e),h&&(location.href=h,h=null)},flush(){h&&(location.href=h)}};g=new l.TransformStream(e,m.writableStrategy,m.readableStrategy);const t=g.readable;p.port1.postMessage({readableStream:t},[t])}p.port1.onmessage=t=>{t.data.download?"navigate"===i?(r.remove(),r=null,u?location.href=t.data.download:h=t.data.download):(r.isPopup&&(r.remove(),r=null,"iframe"===i&&e(l.mitm)),e(t.data.download)):t.data.abort&&(w=[],p.port1.postMessage("abort"),p.port1.onmessage=null,p.port1.close(),p.port2.close(),p=null)},r.loaded?r.postMessage(...c):r.addEventListener("load",()=>{r.postMessage(...c)},{once:!0})}let w=[];return!s&&g&&g.writable||new l.WritableStream({write(e){if(!(e instanceof Uint8Array))throw new TypeError("Can only write Uint8Arrays");s?w.push(e):(p.port1.postMessage(e),u+=e.length,h&&(location.href=h,h=null))},close(){if(s){const e=new Blob(w,{type:"application/octet-stream; charset=utf-8"}),t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=n,t.click()}else p.port1.postMessage("end")},abort(){w=[],p.port1.postMessage("abort"),p.port1.onmessage=null,p.port1.close(),p.port2.close(),p=null}},m.writableStrategy)},WritableStream:t.WritableStream||n.WritableStream,supported:!0,version:{full:"2.0.5",major:2,minor:0,dot:5},mitm:"https://jimmywarting.github.io/StreamSaver.js/mitm.html?version=2.0.0"};try{new Response(new ReadableStream),o&&!("serviceWorker"in navigator)&&(s=!0)}catch(c){s=!0}return(()=>{try{(()=>{const{readable:e}=new TransformStream,t=new MessageChannel;t.port1.postMessage(e,[e]),t.port1.close(),t.port2.close(),a=!0,Object.defineProperty(l,"TransformStream",{configurable:!1,writable:!1,value:TransformStream})})()}catch(e){}})(),l})()}()),L.exports));E.mitm="streamer/mitm.html";let M=0;const k=e=>{const b=r(),[S,U]=t(b("home.package_download.initializing")),[L,k]=t(0),{pathname:T,isShare:C}=a(),W=n(),_=async(e,t)=>{var r;if(t.is_dir){const a=await v(f(T(),e,t.name),y());if(200!==a.code)return a.message;const n=[];for(const o of null!=(r=a.data.content)?r:[]){const r=await _(f(e,t.name),o);if("string"==typeof r)return r;n.push(...r)}return n}return M+=t.size,[{path:f(e,t.name),url:w(f(T(),e),t,"direct",C(),!0)}]},[j,z]=t([]);return(async()=>{let e=g(T());1===W.length&&(e=W[0].name),e||(e=b("manage.sidemenu.home"));let t=E.createWriteStream(`${e}.zip`,{size:M});U(b("home.package_download.fetching_struct")),k(2);const r=[];for(const o of W){const e=await _("",o);if("string"==typeof e)return U(`${b("home.package_download.fetching_struct_failed")}: ${e}`),k(1),e;r.push(...e)}U(b("home.package_download.downloading")),k(3);let a=r.values(),n=new window.ZIP({pull(t){const r=a.next();if(!r.done){let a=r.value.path.replace(/^\/+|\/+$/g,"");1===W.length&&(a=a.replace(`${e}/`,""));const n=r.value.url;return fetch(n).then(e=>{z(e=>[...e,a]),t.enqueue({name:a,stream:e.body})})}t.close()}});window.WritableStream&&n.pipeTo&&n.pipeTo(t).then(()=>{U(`${b("home.package_download.success")}`),k(4)}).catch(e=>{U(`${b("home.package_download.failed")}: ${e}`),k(1)})})(),[o(m,{get children(){return o(s,{w:"$full",alignItems:"start",spacing:"$2",get children(){return[o(i,{get children(){return[l(()=>b("home.package_download.current_status")),": ",l(()=>S())]}}),o(c,{get each(){return j()},children:e=>o(d,{css:{wordBreak:"break-all"},get children(){return["Fetching: ",e]}})})]}})}}),o(p,{get when(){return[1,4].includes(L())},get children(){return o(u,{get children(){return o(h,{colorScheme:"info",get onClick(){return e.onClose},get children(){return b("global.close")}})}})}})]};export{k as default};
