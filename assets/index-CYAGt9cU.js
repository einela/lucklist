import{cn as e,Q as t,ax as r,co as n,cp as o,a2 as a,D as s,an as i,aq as l,V as c,j as u,cj as d,cq as g,N as p,aM as h,bq as f,c6 as m,cr as w,cs as b,ct as C,cu as v,O as y,o as x,B as $,cv as _,b9 as k,au as I,ah as S,b$ as G,aK as j,c0 as E,S as z,I as K,bc as M,ag as P,aw as R,K as U,bB as A,bC as D,cw as L,aR as T,cx as q,r as B,bt as N}from"./index-C_g2pi0Z.js";import{a as O}from"./useTitle-a7nPsmVE.js";import{s as Z,g as J,a as Q}from"./webauthn-json.browser-ponyfill-Bmv6SNib.js";var V=r('<svg version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink height=896 width=967.8852157128662><defs><path id=path-2 opacity=1 fill-rule=evenodd d="M896,448 C1142.6325445712241,465.5747656464056 695.2579309733121,896 448,896 C200.74206902668806,896 5.684341886080802e-14,695.2579309733121 0,448.0000000000001 C0,200.74206902668806 200.74206902668791,5.684341886080802e-14 447.99999999999994,0 C695.2579309733121,0 475,418 896,448Z"></path><linearGradient id=linearGradient-3 x1=0.5 y1=0 x2=0.5 y2=1><stop offset=0 stop-opacity=1></stop><stop offset=1 stop-opacity=1></stop></linearGradient></defs><g opacity=1><use href=#path-2 fill=url(#linearGradient-3) fill-opacity=1>');const F=e=>{const r=t({startColor:"#28aff0",endColor:"#120fc4"},e);return a=V(),s=a.firstChild.firstChild.nextSibling.firstChild,i=s.nextSibling,n(e=>{var t=r.startColor,n=r.endColor;return t!==e.e&&o(s,"stop-color",e.e=t),n!==e.t&&o(i,"stop-color",e.t=n),e},{e:void 0,t:void 0}),a;var a,s,i};var H=r('<svg height=1337 width=1337><defs><path id=path-1 opacity=1 fill-rule=evenodd d="M1337,668.5 C1337,1037.455193874239 1037.455193874239,1337 668.5,1337 C523.6725684305388,1337 337,1236 370.50000000000006,1094 C434.03835568300906,824.6732385973953 6.906089672974592e-14,892.6277623047779 0,668.5000000000001 C0,299.5448061257611 299.5448061257609,1.1368683772161603e-13 668.4999999999999,0 C1037.455193874239,0 1337,299.544806125761 1337,668.5Z"></path><linearGradient id=linearGradient-2 x1=0.79 y1=0.62 x2=0.21 y2=0.86><stop offset=0 stop-opacity=1></stop><stop offset=1 stop-opacity=1></stop></linearGradient></defs><g opacity=1><use href=#path-1 fill=url(#linearGradient-2) fill-opacity=1>');const W=e=>{const r=t({startColor:"#28aff0",endColor:"#120fc4"},e);return a=H(),s=a.firstChild.firstChild.nextSibling.firstChild,i=s.nextSibling,n(e=>{var t=r.startColor,n=r.endColor;return t!==e.e&&o(s,"stop-color",e.e=t),n!==e.t&&o(i,"stop-color",e.t=n),e},{e:void 0,t:void 0}),a;var a,s,i},X=()=>{const e=a("#a9c6ff","#062b74");return s(i,{get bgColor(){return e()},pos:"fixed",top:"0",left:"0",overflow:"hidden",zIndex:"-1",w:"100vw",h:"100vh",get children(){return[s(i,{pos:"absolute",right:{"@initial":"-100px","@sm":"-300px"},top:{"@initial":"-1170px","@sm":"-900px"},get children(){return s(W,{})}}),s(i,{pos:"absolute",left:{"@initial":"-100px","@sm":"-200px"},bottom:{"@initial":"-760px","@sm":"-400px"},get children(){return s(F,{})}})]}})},Y=()=>{function e(e){const t=e.data;t.token&&(d(t.token),a(decodeURIComponent(o.redirect||g||"/"),!0))}const t=l("sso_login_enabled"),r=c("sso_login_platform"),n=l("sso_compatibility_mode"),{searchParams:o,to:a}=u(),i=o.token;if(null!=i&&""!=i&&(d(i),a(decodeURIComponent(o.redirect||g||"/"),!0)),window.addEventListener("message",e),p(()=>{window.removeEventListener("message",e)}),t){const e=()=>{const e=f.getUri()+"/auth/sso?method=sso_get_token";n?window.location.href=e:window.open(e,"authPopup","width=500,height=600")};let t;switch(r){case"Github":t=v;break;case"Microsoft":t=C;break;case"Google":t=b;break;case"Dingtalk":t=w;break;default:t=m}return s(h,{cursor:"pointer",boxSize:"$8",as:t,p:"$0_5",onclick:e})}},ee=()=>{const t=c("logo").split("\n"),r=a(t[0],t.pop()),n=x(),o=y(()=>`${n("login.login_to")} ${c("site_title")}`);O(o);const i=a("white","$neutral1"),[m,w]=$(localStorage.getItem("username")||""),[b,C]=$(localStorage.getItem("password")||""),[v,V]=$(""),[F,H]=$(!1),[W,ee]=_("remember-pwd","false"),[te,re]=$(!1),[ne,oe]=k(async()=>{return te()?f.post("/auth/login/ldap",{username:m(),password:b(),otp_code:v()}):f.post("/auth/login/hash",{username:m(),password:(t=b(),e(`${t}-https://github.com/alist-org/alist`)),otp_code:v()});var t}),[,ae]=k((e,t,r,n)=>f.post("/authn/webauthn_finish_login?username="+r,JSON.stringify(t),{headers:{session:e},signal:n})),[,se]=k((e,t)=>f.get("/authn/webauthn_begin_login?username="+e,{signal:t})),{searchParams:ie,to:le}=u(),ce=l("webauthn_login_enabled"),ue=async()=>{H(!F())};let de=null;const ge=async e=>{if(!Z())return void(e||B.error(n("users.webauthn_not_supported")));if(e&&!(await(async()=>!(!PublicKeyCredential||!("isConditionalMediationAvailable"in PublicKeyCredential))&&await PublicKeyCredential.isConditionalMediationAvailable())()))return;null==de||de.abort();const t=new AbortController;de=t;const r=e?"":m();e||"true"!==W()?localStorage.removeItem("username"):localStorage.setItem("username",m());const o=await se(r,t.signal);N(o,async o=>{try{const a=J(o.options);a.signal=t.signal,e&&(a.mediation="conditional");const s=await Q(a),i=await ae(o.session,s,r,t.signal);q(i,e=>{B.success(n("login.success")),d(e.token),le(decodeURIComponent(ie.redirect||g||"/"),!0)})}catch(a){a instanceof Error&&"AbortError"!=a.name&&B.error(a.message)}})},pe=()=>null==de?void 0:de.abort();I(()=>{ce&&(window.addEventListener("beforeunload",pe),ge(!0))}),p(()=>{null==de||de.abort(),window.removeEventListener("beforeunload",pe)});const he=async()=>{if(F())await ge();else{"true"===W()?(localStorage.setItem("username",m()),localStorage.setItem("password",b())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const e=await oe();q(e,e=>{B.success(n("login.success")),d(e.token),le(decodeURIComponent(ie.redirect||g||"/"),!0)},(e,t)=>{fe()||402!==t?B.error(e):me(!0)})}},[fe,me]=$(!1),we=l("ldap_login_enabled"),be=c("ldap_login_tips");return we&&re(!0),s(T,{zIndex:"1",w:"$full",h:"100vh",get children(){return[s(S,{get bgColor(){return i()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[s(G,{alignItems:"center",justifyContent:"space-around",get children(){return[s(j,{mr:"$2",boxSize:"$12",get src(){return r()}}),s(E,{color:"$info9",fontSize:"$2xl",get children(){return o()}})]}}),s(z,{get when(){return!fe()},get fallback(){return s(K,{id:"totp",name:"otp",get placeholder(){return n("login.otp-tips")},get value(){return v()},onInput:e=>V(e.currentTarget.value),onKeyDown:e=>{"Enter"===e.key&&he()}})},get children(){return[s(K,{name:"username",get placeholder(){return n("login.username-tips")},get value(){return m()},onInput:e=>w(e.currentTarget.value)}),s(z,{get when(){return!F()},get children(){return s(K,{name:"password",get placeholder(){return n("login.password-tips")},type:"password",get value(){return b()},onInput:e=>C(e.currentTarget.value),onKeyDown:e=>{"Enter"===e.key&&he()}})}}),s(G,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return[s(M,{get checked(){return"true"===W()},onChange:()=>ee("true"===W()?"false":"true"),get children(){return n("login.remember")}}),s(P,{as:"a",target:"_blank",get href(){return n("login.forget_url")},get children(){return n("login.forget")}})]}})]}}),s(R,{w:"$full",spacing:"$2",get children(){return[s(z,{get when(){return!F()},get children(){return s(U,{colorScheme:"primary",w:"$full",onClick:()=>{fe()?V(""):(w(""),C(""))},get children(){return n("login.clear")}})}}),s(U,{w:"$full",get loading(){return ne()},onClick:he,get children(){return n("login.login")}})]}}),s(z,{when:we,get children(){return s(M,{w:"$full",get checked(){return!0===te()},onChange:()=>re(!te()),children:be})}}),s(U,{w:"$full",colorScheme:"accent",onClick:()=>{d(),le(decodeURIComponent(ie.redirect||g||"/"),!0)},get children(){return n("login.use_guest")}}),s(G,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[s(A,{}),s(D,{}),s(Y,{}),s(z,{when:ce,get children(){return s(h,{cursor:"pointer",boxSize:"$8",as:L,p:"$0_5",onclick:ue})}})]}})]}}),s(X,{})]}})};export{ee as default};
