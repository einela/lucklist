import{b9 as e,bq as r,B as n,D as t,cy as s,ah as a,c0 as i,K as o,o as c,bt as u,r as d,S as l,j as g,a6 as h,aq as p,d9 as m,N as w,a5 as _,da as f,bR as b,bE as $,I as y,H as v,aw as I,db as k,dc as C,dd as j,de as x,ag as S,ab as E,ao as P,R,aW as T,cx as D,cz as L}from"./index-C_g2pi0Z.js";import{b as U}from"./useTitle-a7nPsmVE.js";import{L as q}from"./index-DJbwiRYC.js";import{s as B,c as K,b as N}from"./webauthn-json.browser-ponyfill-Bmv6SNib.js";import{P as z}from"./PublicKeys-DEtaRVTu.js";const F=g=>{const h=c(),[p,m]=e(()=>r.post("/authn/delete_authn",{id:g.id})),[w,_]=n(!1);return t(l,{get when(){return!w()},get children(){return t(s,{w:"$full",overflowX:"auto",shadow:"$md",rounded:"$lg",p:"$2",direction:{"@initial":"column","@xl":"row"},spacing:"$2",get children(){return[t(a,{w:"$full",alignItems:"start",spacing:"$1",get children(){return t(i,{color:"$info9",css:{wordBreak:"break-all"},get children(){return"Fingerprint: "+g.fingerprint+"\tID: "+g.id}})}}),t(s,{direction:{"@initial":"row","@xl":"column"},justifyContent:{"@xl":"center"},spacing:"$1",get children(){return t(o,{colorScheme:"danger",get loading(){return p()},onClick:async()=>{const e=await m();u(e,()=>{d.success(h("global.delete_success")),_(!0)})},get children(){return h("global.delete")}})}})]}})}})},H=e=>t(L,{get colorScheme(){return e.can?"success":"danger"},get children(){return e.children}}),J=()=>{function s(e){const r=e.data;r.sso_id&&(m({...h(),sso_id:r.sso_id}),ae(!0))}const L=c();U("manage.sidemenu.profile");const{searchParams:J,to:M}=g(),[O,W]=n(h().username),[X,A]=n(""),[G,Q]=n(""),V=p("sso_compatibility_mode"),[Y,Z]=e(e=>r.post("/me/update",{username:e?h().username:O(),password:e?"":X(),sso_id:h().sso_id})),[ee,re]=e(()=>r.get("/authn/getcredentials")),[,ne]=e(()=>r.get("/authn/webauthn_begin_registration")),[te,se]=e((e,n)=>r.post("/authn/webauthn_finish_registration",JSON.stringify(n),{headers:{session:e}})),ae=async e=>{if(X()&&X()!==G())return void d.warning(L("users.confirm_password_not_same"));const r=await Z(e);u(r,()=>{m({...h(),username:O()}),e?M(""):(d.success(L("users.update_profile_success")),M(`/@login?redirect=${encodeURIComponent(location.pathname1)}`))})},ie=J.sso_id;ie&&(m({...h(),sso_id:ie}),ae(!0)),window.addEventListener("message",s),w(()=>{window.removeEventListener("message",s)});const[oe,ce]=n([]);return B()&&!_.is_guest(h())&&p("webauthn_login_enabled")&&(async()=>{const e=await re();D(e,ce)})(),t(a,{w:"$full",spacing:"$4",alignItems:"start",get children(){return[t(l,{get when(){return!_.is_guest(h())},get fallback(){return[t(k,{status:"warning",flexDirection:{"@initial":"column","@lg":"row"},get children(){return[t(C,{mr:"$2_5"}),t(j,{mr:"$2_5",get children(){return L("users.guest-tips")}}),t(x,{get children(){return L("users.modify_nothing")}})]}}),t(I,{spacing:"$2",get children(){return[t(S,{get children(){return L("global.have_account")}}),t(S,{color:"$info9",as:q,get href(){return`/@login?redirect=${encodeURIComponent(location.pathname1)}`},get children(){return L("global.go_login")}})]}})]},get children(){return[t(i,{get children(){return L("users.update_profile")}}),t(f,{gap:"$2",columns:{"@initial":1,"@md":2},get children(){return t(b,{get children(){return[t($,{for:"username",get children(){return L("users.change_username")}}),t(y,{id:"username",get value(){return O()},onInput:e=>{W(e.currentTarget.value)}})]}})}}),t(f,{gap:"$2",columns:{"@initial":1,"@md":2},get children(){return[t(b,{get children(){return[t($,{for:"password",get children(){return L("users.change_password")}}),t(y,{id:"password",type:"password",placeholder:"********",get value(){return X()},onInput:e=>{A(e.currentTarget.value)}}),t(v,{get children(){return L("users.change_password-tips")}})]}}),t(b,{get children(){return[t($,{for:"confirm-password",get children(){return L("users.confirm_password")}}),t(y,{id:"confirm-password",type:"password",placeholder:"********",get value(){return G()},onInput:e=>{Q(e.currentTarget.value)}}),t(v,{get children(){return L("users.confirm_password-tips")}})]}})]}}),t(I,{spacing:"$2",get children(){return[t(o,{get loading(){return Y()},onClick:[ae,!1],get children(){return L("global.save")}}),t(l,{get when(){return!h().otp},get children(){return t(o,{colorScheme:"accent",onClick:()=>{M("/@manage/2fa")},get children(){return L("users.enable_2fa")}})}})]}})]}}),t(l,{get when(){return E(()=>!!p("sso_login_enabled"))()&&!_.is_guest(h())},get children(){return[t(i,{get children(){return L("users.sso_login")}}),t(I,{spacing:"$2",get children(){return t(l,{get when(){return h().sso_id},get fallback(){return t(o,{onClick:()=>{const e=r.getUri()+"/auth/sso?method=get_sso_id";V?window.location.href=e:window.open(e,"authPopup","width=500,height=600")},get children(){return L("users.connect_sso")}})},get children(){return t(o,{colorScheme:"danger",get loading(){return Y()},onClick:()=>{m({...h(),sso_id:""}),ae(!0)},get children(){return L("users.disconnect_sso")}})}})}})]}}),t(l,{get when(){return E(()=>!_.is_guest(h()))()&&p("webauthn_login_enabled")},get children(){return[t(i,{get children(){return L("users.webauthn")}}),t(I,{wrap:"wrap",gap:"$2",mt:"$2",get children(){return t(P,{get loading(){return ee()},get children(){return t(R,{get each(){return oe()},children:e=>t(F,{get id(){return e.id},get fingerprint(){return e.fingerprint}})})}})}}),t(o,{get loading(){return te()},onClick:async()=>{if(!B())return void d.error(L("users.webauthn_not_supported"));const e=await ne();u(e,async e=>{const r=K(e.options),n=e.session;try{const e=await N(r);u(await se(n,e),()=>{d.success(L("users.add_webauthn_success"))})}catch(t){t instanceof Error&&d.error(t.message)}})},get children(){return L("users.add_webauthn")}})]}}),t(I,{wrap:"wrap",gap:"$2",mt:"$2",get children(){return t(R,{each:T,children:(e,r)=>t(H,{get can(){return _.can(h(),r())},get children(){return L(`users.permissions.${e}`)}})})}}),t(z,{isMine:!0,get userId(){return h().id}})]}})};export{J as default};
