import{j as e,B as t,e2 as r,a4 as a,au as s,N as i,ax as n,aZ as o,D as l,ac as c,S as h,aa as y,o as d,co as f,ea as w}from"./index-C_g2pi0Z.js";var p=n("<div id=heic-container><canvas>");const u=()=>{const n=d();e();const[u,g]=t(!0),[m,P]=t(!1),{libHeifPath:v}=r();let b,j,x,C=a.objs.filter(e=>/\.(heic|heif|avif|vvc|avc|jpeg|jpg)$/i.test(e.name));0===C.length&&(C=[a.obj]),s(()=>{$()}),i(()=>{b&&j&&(j=null),b=null});const $=async()=>{g(!0),P(!1);try{window.libheif||await _(`${v()}/libheif.js`,"libheif-script");const e=await B(`${v()}/libheif.wasm`);b=window.libheif({wasmBinary:e}),j=new b.HeifDecoder,await D(a.raw_url)}catch(e){console.error("HEIC初始化失败:",e),P(!0),g(!1)}},_=(e,t)=>new Promise((r,a)=>{const s=document.createElement("script");s.src=e,s.id=t,s.onload=()=>r(),s.onerror=()=>a(`脚本加载失败: ${e}`),document.head.appendChild(s)}),B=async e=>{const t=await fetch(e);if(!t.ok)throw`WASM加载失败: ${e}`;return await t.arrayBuffer()},D=async e=>{try{g(!0),P(!1);const t=await fetch(e);if(!t.ok)throw"文件获取失败";const r=await t.arrayBuffer(),a=j.decode(r);if(!a||0===a.length)throw"没有可解码的图像";const s=a[0];await H(s),g(!1)}catch(t){console.error("HEIC解码失败:",t),P(!0),g(!1)}},H=e=>new Promise(t=>{if(!x)return t();const r=e.get_width(),a=e.get_height();x.width=r,x.height=a;const s=new ImageData(r,a);e.display(s,e=>{if(!e||!x)return t();const r=x.getContext("2d");if(!r)return t();r.putImageData(e,0,0),t()})});return I=p(),k=I.firstChild,I.style.setProperty("position","relative"),I.style.setProperty("width","100%"),I.style.setProperty("height","75vh"),I.style.setProperty("display","flex"),I.style.setProperty("justify-content","center"),I.style.setProperty("align-items","center"),I.style.setProperty("overflow","hidden"),"function"==typeof x?w(x,k):x=k,k.style.setProperty("max-width","100%"),k.style.setProperty("max-height","100%"),k.style.setProperty("object-fit","contain"),o(I,l(h,{get when(){return u()},get children(){return l(c,{})}}),null),o(I,l(h,{get when(){return m()},get children(){return l(y,{get msg(){return n("preview.failed_load_heic")},h:"75vh"})}}),null),f(e=>null!=(e=u()||m()?"none":"block")?k.style.setProperty("display",e):k.style.removeProperty("display")),I;var I,k};export{u as default};
