import{a6 as e,b9 as t,bq as r,B as n,D as a,aw as s,bc as l,c0 as o,S as c,aR as i,cB as d,cC as u,ag as g,b$ as h,dj as p,K as m,o as w,bt as $,r as f,ab as k,ah as v,dk as x,dl as y,R as _,dm as b,cz as S,O as C,N as z,C as A,I as T,Q as B,bT as P,ax as F,aZ as R,co as I,dn as O,cp as j,dp as D}from"./index-C_g2pi0Z.js";import{P as E}from"./Paginator-Dvd1jki1.js";const L={7:"danger",2:"success",4:"neutral"},W=e=>{if(e.role<0)return null;const t=["info","neutral","accent"];return a(S,{get colorScheme(){return t[e.role]},css:{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},get children(){return e.name}})},G=e=>{const t=w();return a(S,{get colorScheme(){var t;return null!=(t=L[e.state])?t:"info"},get children(){return t(`tasks.state.${e.state}`)}})},K=[{name:"name",textAlign:"left",w:2===e().role?"calc(100% - 660px)":"calc(100% - 560px)"},{name:"creator",textAlign:"center",w:2===e().role?"100px":"0"},{name:"state",textAlign:"center",w:"100px"},{name:"progress",textAlign:"left",w:"140px"},{name:"speed",textAlign:"center",w:"100px"},{name:"operation",textAlign:"right",w:"220px"}],M=e=>Math.floor(e).toString().padStart(2,"0"),q=S=>{const C=w(),z="undone"===S.done?"cancel":"delete",A="done"===S.done&&(7===S.state||4===S.state),[T,B]=t(()=>r.post(`/task/${S.type}/${z}?tid=${S.id}`)),[P,F]=t(()=>r.post(`/task/${S.type}/retry?tid=${S.id}`)),[R,I]=n(!1),O=S.name.match(S.nameAnalyzer.regex),j=null===O?S.name:S.nameAnalyzer.title(O),D=null===S.start_time?-1:new Date(S.start_time).getTime(),E=null===S.end_time?(new Date).getTime():new Date(S.end_time).getTime();let L="-";const q=(e,t)=>{let r=t/e,n="bytes/s";return r>1024&&(r/=1024,n="KB/s"),r>1024&&(r/=1024,n="MB/s"),r>1024&&(r/=1024,n="GB/s"),`${r.toFixed(2)} ${n}`};if(S.done){if(S.start_time!==S.end_time&&S.progress>0&&-1!==D){const e=(E-D)/1e3,t=S.total_bytes*S.progress/100;L=q(e,t)}}else if(void 0!==S.prevProgress&&void 0!==S.prevFetchTime){const e=(S.curFetchTime-S.prevFetchTime)/1e3,t=(S.progress-S.prevProgress)*S.total_bytes/100;L=q(e,t)}return a(c,{get when(){return!R()},get children(){return[a(s,{w:"$full",p:"$2",get children(){return[a(s,{get w(){return K[0].w},spacing:"$1",get children(){return[a(l,{"on:click":e=>{e.stopPropagation()},get checked(){return S.local.selected},onChange:e=>{S.setLocal({selected:e.target.checked,expanded:S.local.expanded})}}),a(o,{size:"sm",css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:j})]}}),a(c,{get when(){return 2===e().role},get children(){return a(i,{get w(){return K[1].w},get children(){return a(W,{get name(){return S.creator},get role(){return S.creator_role}})}})}}),a(i,{get w(){return K[2].w},get children(){return a(G,{get state(){return S.state}})}}),a(d,{get w(){return K[3].w},trackColor:"$info3",rounded:"$full",size:"sm",get value(){return S.progress},mr:"$1",get children(){return a(u,{color:"$info8",rounded:"$md"})}}),a(i,{get w(){return K[1].w},get children(){return a(g,{size:"sm",css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:L})}}),a(h,{get w(){return K[5].w},gap:"$1",get children(){return[a(p,{}),a(c,{get when(){return S.canRetry},get children(){return a(m,{size:"sm",disabled:!A,display:A?"block":"none",get loading(){return P()},onClick:async()=>{const e=await F();$(e,()=>{f.info(C("tasks.retry")),I(!0)})},get children(){return C("tasks.retry")}})}}),a(m,{size:"sm",colorScheme:"danger",get loading(){return T()},onClick:async()=>{const e=await B();$(e,()=>{f.success(C("global.delete_success")),I(!0)})},get children(){return C(`global.${z}`)}}),a(m,{size:"sm",colorScheme:"neutral",onClick:()=>{S.setLocal({selected:S.local.selected,expanded:!S.local.expanded})},get children(){return k(()=>!!S.local.expanded)()?C("tasks.fold"):C("tasks.expand")}})]}})]}}),a(c,{get when(){return S.local.expanded},get children(){return a(v,{css:{wordBreak:"break-all",fontSize:"0.8em"},w:"$full",pl:"$2",pr:"$2",get children(){return[a(x,{templateColumns:"min-content 1fr",w:"$full",columnGap:"$4",mb:"$2",get children(){return[a(c,{when:-1!==D,get children(){return[a(y,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return C("tasks.attr.time_elapsed")}}),a(y,{color:"$neutral9",get children(){return(e=>{const t=e/1e3%60,r=e/1e3/60%60;return`${M(e/1e3/3600)}:${M(r)}:${M(t)}`})(E-D)}})]}}),a(c,{when:null!==O,get children(){return a(_,{get each(){return Object.entries(S.nameAnalyzer.attrs)},children:e=>{const t=e[1](O);return void 0===t?null:a(c,{get when(){return void 0!==e[1]},get children(){return[a(y,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return e[0]}}),a(y,{color:"$neutral9",children:t})]}})}})}}),a(y,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return C("tasks.attr.status")}}),a(y,{color:"$neutral9",get children(){return S.status}}),a(c,{get when(){return S.error},get children(){return[a(y,{color:"$danger9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return C("tasks.attr.err")}}),a(y,{color:"$danger9",get children(){return S.error}})]}})]}}),a(b,{})]}})}})]}})},N=i=>{const d=w(),[u,x]=t(()=>r.get(`/task/${i.type}/${i.done}`)),[y,_]=n([]),[b,S]=n("name"),[F,R]=n(!1),I={name:(e,t)=>e.name>t.name?1:-1,creator:(e,t)=>e.creator===t.creator?e.id>t.id?1:-1:e.creator>t.creator?1:-1,state:(e,t)=>e.state===t.state?e.id>t.id?1:-1:e.state>t.state?1:-1,progress:(e,t)=>e.progress===t.progress?e.id>t.id?1:-1:e.progress<t.progress?1:-1},O=C(()=>(e,t)=>(F()?-1:1)*I[b()](e,t)),j=async()=>{const e=await x();$(e,e=>{var t;const r=(new Date).getTime(),n={},a={},s={},l={},o={};for(const c of y())n[c.id]=c.curFetchTime,a[c.id]=c.prevFetchTime,s[c.id]=c.progress,l[c.id]=c.prevProgress,o[c.id]=c.local;_(null!=(t=null==e?void 0:e.map(e=>{var t;let c,i;e.progress===s[e.id]?(c=a[e.id],i=l[e.id]):(c=n[e.id],i=s[e.id]);const d=null!=(t=o[e.id])?t:{selected:!1,expanded:!1};return{...e,curFetchTime:r,prevFetchTime:c,prevProgress:i,local:d}}).sort(O()))?t:[])})};if(j(),"undone"===i.done){const e=setInterval(j,2e3);z(()=>clearInterval(e))}const[D,L]=t(()=>r.post(`/task/${i.type}/clear_done`)),[W,G]=t(()=>r.post(`/task/${i.type}/clear_succeeded`)),[M,N]=t(()=>r.post(`/task/${i.type}/retry_failed`)),[Q,X]=n(""),[Z,H]=n(new RegExp("")),[J,U]=n(!1);A(()=>{try{H(new RegExp(Q())),U(!1)}catch(e){U(!0)}});const[V,Y]=n(2!==e().role),ee=C(()=>{const t=Z(),r=V();return n=>t.test(n.name)&&(!r||n.creator===e().username)}),te=C(()=>y().filter(ee())),re=C(()=>te().map(e=>e.local.selected).every(Boolean)),ne=C(()=>te().map(e=>e.local.selected).some(Boolean)&&!re()),ae=C(()=>te().map(e=>e.local.expanded).every(Boolean)),se=()=>te().filter(e=>e.local.selected).map(e=>e.id),[le,oe]=t(()=>r.post(`/task/${i.type}/retry_some`,se())),[ce,ie]=t(()=>r.post(`/task/${i.type}/${he}_some`,se())),de=e=>{Object.entries(e).forEach(([e,t])=>{f.error(`${e}: ${t}`)})},[ue,ge]=n(1),he="undone"===i.done?"cancel":"delete",pe=C(()=>{const e=20*(ue()-1),t=e+20;return te().slice(e,t)}),me=e=>({fontWeight:"bold",fontSize:"$sm",color:"$neutral11",textAlign:e.textAlign}),we=e=>({cursor:"pointer",onClick:()=>{b()===e.name?R(!F()):P(()=>{S(e.name),R(!1)}),j()}});return a(v,{w:"$full",alignItems:"start",spacing:"$2",get children(){return[a(o,{size:"lg",get children(){return d(`tasks.${i.done}`)}}),a(s,{gap:"$2",flexWrap:"wrap",get children(){return[a(c,{get when(){return"done"===i.done},get children(){return[a(m,{colorScheme:"accent",get loading(){return u()},onClick:j,get children(){return d("global.refresh")}}),a(m,{get loading(){return M()},onClick:async()=>{const e=await N();$(e,()=>j())},get children(){return d("tasks.retry_failed")}}),a(m,{colorScheme:"danger",get loading(){return D()},onClick:async()=>{const e=await L();$(e,()=>j())},get children(){return d("global.clear")}}),a(m,{colorScheme:"success",get loading(){return W()},onClick:async()=>{const e=await G();$(e,()=>j())},get children(){return d("tasks.clear_succeeded")}})]}}),a(c,{get when(){return i.canRetry},get children(){return a(m,{colorScheme:"primary",get loading(){return le()},onClick:async()=>{const e=await oe();$(e,e=>{de(e),j()})},get children(){return d("tasks.retry_selected")}})}}),a(m,{colorScheme:"warning",get loading(){return ce()},onClick:async()=>{const e=await ie();$(e,e=>{de(e),j()})},get children(){return d(`tasks.${he}_selected`)}}),a(T,{width:"auto",get placeholder(){return d("tasks.filter")},get value(){return Q()},onInput:e=>X(e.target.value),get invalid(){return J()}}),a(c,{get when(){return 2===e().role},get children(){return a(l,{get checked(){return V()},onChange:e=>Y(e.target.checked),get children(){return d("tasks.show_only_mine")}})}})]}}),a(v,{w:{"@initial":"1024px","@lg":"$full"},overflowX:"auto",shadow:"$md",rounded:"$lg",spacing:"$1",p:"$1",get children(){return[a(s,{class:"title",w:"$full",p:"$2",get children(){return[a(s,{get w(){return K[0].w},spacing:"$1",get children(){return[a(l,{get disabled(){return 0===te().length},get checked(){return re()},get indeterminate(){return ne()},onChange:e=>{return t=e.target.checked,_(y().map(e=>(ee()(e)&&(e.local.selected=t),e)));var t}}),a(g,B(()=>me(K[0]),()=>we(K[0]),{get children(){return d(`tasks.attr.${K[0].name}`)}}))]}}),a(c,{get when(){return 2===e().role},get children(){return a(g,B({get w(){return K[1].w}},()=>me(K[1]),()=>we(K[1]),{get children(){return d(`tasks.attr.${K[1].name}`)}}))}}),a(g,B({get w(){return K[2].w}},()=>me(K[2]),()=>we(K[2]),{get children(){return d(`tasks.attr.${K[2].name}`)}})),a(g,B({get w(){return K[3].w}},()=>me(K[3]),()=>we(K[3]),{get children(){return d(`tasks.attr.${K[3].name}`)}})),a(g,B({get w(){return K[4].w}},()=>me(K[4]),{get children(){return d(`tasks.attr.${K[4].name}`)}})),a(h,{get w(){return K[5].w},gap:"$2",get children(){return[a(p,{}),a(g,B(()=>me(K[5]),{get children(){return d(`tasks.attr.${K[5].name}`)}})),a(m,{size:"xs",colorScheme:"neutral",onClick:()=>{return e=!ae(),_(y().map(t=>(ee()(t)&&(t.local.expanded=e),t)));var e},get disabled(){return 0===te().length},get children(){return k(()=>!!ae())()?d("tasks.fold_all"):d("tasks.expand_all")}})]}})]}}),k(()=>pe().map(e=>a(q,B(e,i,{get setLocal(){return t=e.id,e=>_(y().map(r=>(r.id===t&&(r.local=e),r)));var t}}))))]}}),a(E,{get total(){return te().length},defaultPageSize:20,onChange:e=>{ge(e)}})]}})},Q=e=>{const t=w();return a(v,{w:"$full",alignItems:"start",spacing:"$4",get children(){return[a(o,{size:"xl",get children(){return t(`tasks.${e.type}`)}}),a(v,{w:"$full",spacing:"$2",get children(){return a(_,{each:["undone","done"],children:t=>a(N,{get type(){return e.type},done:t,get canRetry(){return e.canRetry},get nameAnalyzer(){return e.nameAnalyzer}})})}})]}})};var X=F("<a>"),Z=F("<p>"),H=F("<a target=_blank>");const J=(t,r,a=!0)=>{const s=("/"===t?"":t)+r,l="/"===e().base_path?"":e().base_path,o=s.startsWith(l),[c,i]=n(!1);return o&&a?((u=X()).$$mouseout=()=>i(!1),u.$$mouseover=()=>i(!0),R(u,s),I(e=>{var t=c()?"text-decoration: underline":"",r=s.slice(l.length);return e.e=O(u,t,e.e),r!==e.t&&j(u,"href",e.t=r),e},{e:void 0,t:void 0}),u):(d=Z(),R(d,s),d);var d,u},U=()=>{const e=w(),[t,r]=n(!1);return{regex:/^download (.+) to \((.+)\)$/,title:e=>e[1],attrs:{[e("tasks.attr.offline_download.url")]:e=>{return(n=H()).$$mouseout=()=>r(!1),n.$$mouseover=()=>r(!0),R(n,()=>e[1]),I(r=>{var a=t()?"text-decoration: underline":"",s=e[1];return r.e=O(n,a,r.e),s!==r.t&&j(n,"href",r.t=s),r},{e:void 0,t:void 0}),n;var n},[e("tasks.attr.offline_download.path")]:e=>J("",e[2])}}},V=()=>{const e=w(),[t,r]=n(!1);return{regex:/^(transfer|upload) \[(.*)]\((.*\/([^\/]+))\) to \[(.+)]\((.+)\)$/,title:e=>"upload"===e[1]?e[2]:e[4],attrs:{[e("tasks.attr.offline_download.transfer_src")]:e=>"transfer"!==e[1]||""===e[2]?void 0:J(e[2],e[3]),[e("tasks.attr.offline_download.transfer_src_local")]:e=>""===e[2]?e[3]:void 0,[e("tasks.attr.offline_download.url")]:e=>{return"upload"===e[1]?((n=H()).$$mouseout=()=>r(!1),n.$$mouseover=()=>r(!0),R(n,()=>e[3]),I(r=>{var a=t()?"text-decoration: underline":"",s=e[3];return r.e=O(n,a,r.e),s!==r.t&&j(n,"href",r.t=s),r},{e:void 0,t:void 0}),n):void 0;var n},[e("tasks.attr.offline_download.transfer_dst")]:e=>J(e[5],e[6])}}},Y=()=>{const e=w();return{regex:/^decompress \[(.+)]\((.*\/([^\/]+))\)\[(.+)] to \[(.+)]\((.+)\) with password <(.*)>$/,title:e=>e[3],attrs:{[e("tasks.attr.decompress.src")]:e=>J(e[1],e[2]),[e("tasks.attr.decompress.dst")]:e=>J(e[5],e[6]),[e("tasks.attr.decompress.inner")]:e=>{return t=Z(),R(t,()=>e[4]),t;var t},[e("tasks.attr.decompress.password")]:e=>{return t=Z(),R(t,()=>e[7]),t;var t}}}},ee=()=>{const e=w();return{regex:/^upload (.+) to \[(.+)]\((.+)\)$/,title:e=>e[1],attrs:{[e("tasks.attr.decompress.dst")]:e=>J(e[2],e[3])}}};D(["mouseover","mouseout"]);export{Q as T,V as a,J as b,Y as c,ee as d,U as g};
