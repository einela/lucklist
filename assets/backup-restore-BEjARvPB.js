import{B as e,b9 as t,bq as n,D as r,aw as s,K as a,o,bR as i,b$ as c,bE as l,bQ as u,I as d,ah as g,R as m,cx as p,r as f,ag as b}from"./index-C_g2pi0Z.js";import{b as h}from"./useTitle-a7nPsmVE.js";import{c as y}from"./index-B5f7FnMG.js";const _={success:{icon:"✅",color:"$success9"},error:{icon:"❌",color:"$danger9"},info:{icon:"ℹ️",color:"$info9"}},w=e=>r(s,{w:"$full",spacing:"$1",get children(){return[r(b,{get children(){return _[e.type].icon}}),r(b,{get color(){return _[e.type].color},get children(){return e.msg}})]}}),$=()=>{function b(e,t){if(""==t)return e;const n=y.AES.encrypt(JSON.stringify(e),t).toString();return y.enc.Base64.stringify(y.enc.Utf8.parse(n))}function _(e,t,n,r){if(!r)return e;const s=y.enc.Base64.parse(e).toString(y.enc.Utf8);return n?y.AES.decrypt(s,t).toString(y.enc.Utf8):JSON.parse(y.AES.decrypt(s,t).toString(y.enc.Utf8))}async function $(e,t,n,r,s,a){const o=(await t()).data.content;for(const i in e){const t=e[i],c=t[s],l="add"==(o.find(e=>e[s]===c)?"update":"add")?n:r;await p(await l(t),()=>{E(x("br.success_restore_item",{item:x(a)})+`-[${c}]`,"success")},e=>{E(x("br.failed_restore_item",{item:x(a)})+`-[${c}]:`+e,"error")})}}const[k,S]=e(!1),[v,j]=e(""),x=o();let U;h("manage.sidemenu.backup-restore");const[O,R]=e([]),E=(e,t)=>{R(n=>[...n,{type:t,msg:e}]),U.scrollTop=U.scrollHeight},[B,L]=t(()=>n.get("/admin/setting/list")),[T,A]=t(()=>n.get("/admin/user/list")),[J,N]=t(()=>n.get("/admin/meta/list")),[C,D]=t(()=>n.get("/admin/storage/list")),I=async()=>{E(x("br.start_backup"),"info");const e={encrypted:"",settings:[],users:[],storages:[],metas:[]};""!=v()&&(e.encrypted=b("encrypted",v()));for(const t of[{name:"settings",fn:L,page:!1},{name:"users",fn:A,page:!0},{name:"storages",fn:D,page:!0},{name:"metas",fn:N,page:!0}]){const n=await t.fn();p(n,n=>{if(E(x("br.success_backup_item",{item:x(`manage.sidemenu.${t.name}`)}),"success"),t.page){for(let e=0;e<n.content.length;e++){const t=n.content[e];for(const e in t)t[e]=b(t[e],v())}e[t.name]=n.content}else{for(let e=0;e<n.length;e++){const t=n[e];for(const e in t)t[e]=b(t[e],v())}e[t.name]=n}},e=>{E(x("br.failed_backup_item",{item:x(`manage.sidemenu.${t.name}`)})+":"+e,"error")})}!function(e,t){const n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),r=URL.createObjectURL(n),s=document.createElement("a");s.href=r,s.download=e,s.click(),URL.revokeObjectURL(r)}("openlist_backup_"+(new Date).toLocaleString()+".json",e),E(x("br.finish_backup"),"info")},[q,F]=t(e=>n.post("/admin/setting/save",e)),[H,K]=t(e=>n.post("/admin/user/create",e)),[Q,Y]=t(e=>n.post("/admin/storage/create",e)),[z,G]=t(e=>n.post("/admin/meta/create",e)),[M,P]=t(e=>n.post("/admin/user/update",e)),[V,W]=t(e=>n.post("/admin/storage/update",e)),[X,Z]=t(e=>n.post("/admin/meta/update",e));return r(g,{spacing:"$2",w:"$full",get children(){return[r(s,{spacing:"$2",w:"$full",get children(){return[r(a,{get loading(){return B()||T()||J()||C()},onClick:()=>{I()},colorScheme:"accent",get children(){return x("br.backup")}}),r(a,{get loading(){return q()||H()||Q()||z()||M()||V()||X()},onClick:()=>{(async()=>{E(x("br.start_restore"),"info");const e=document.createElement("input");e.type="file",e.accept="application/json",e.onchange=async e=>{const t=e.target.files;if(!t||0===t.length)return void f.warning(x("br.no_file"));const n=t[0],r=new FileReader;r.onload=async()=>{const e=JSON.parse(r.result),t=Boolean(e.encrypted);if(t&&'"encrypted"'!==_(e.encrypted,v(),!0,!0))return void E(x("br.wrong_encrypt_password"),"error");const n=Object.values(e);for(let r=n.length-4;r<n.length;r++){const e=n[r];console.log(e);for(let n=0;n<e.length;n++){const r=e[n];for(const e in r)r[e]=_(r[e],v(),!1,t)}}if(k()&&await I(),e.settings&&p(await F(e.settings.filter(e=>!["version","index_progress"].includes(e.key))),()=>{E(x("br.success_restore_item",{item:x("manage.sidemenu.settings")}),"success")},e=>{E(x("br.failed_restore_item",{item:x("manage.sidemenu.settings")})+":"+e,"error")}),k())await $(e.users,A,K,P,"username","manage.sidemenu.users"),await $(e.storages,D,Y,W,"mount_path","manage.sidemenu.storages"),await $(e.metas,N,G,Z,"path","manage.sidemenu.metas");else for(const r of[{name:"users",fn:K,data:e.users,key:"username"},{name:"storages",fn:Y,data:e.storages,key:"mount_path"},{name:"metas",fn:G,data:e.metas,key:"path"}])for(const e of r.data||[])e.id=0,p(await r.fn(e),()=>{E(x("br.success_restore_item",{item:x(`manage.sidemenu.${r.name}`)})+`-[${e[r.key]}]`,"success")},t=>{E(x("br.failed_restore_item",{item:x(`manage.sidemenu.${r.name}`)})+` [ ${e[r.key]} ] :`+t,"error")});E(x("br.finish_restore"),"info")},r.readAsText(n)},e.click()})()},get children(){return x("br.restore")}})]}}),r(i,{w:"$full",display:"flex",flexDirection:"column",get children(){return r(c,{w:"$full",direction:"column",gap:"$1",get children(){return[r(l,{get children(){return x("br.override")}}),r(u,{id:"restore-override",get checked(){return k()},onChange:e=>S(e.currentTarget.checked)}),r(l,{get children(){return x("br.encrypt_password")}}),r(d,{id:"password",type:"password",get placeholder(){return x("br.encrypt_password_placeholder")},onInput:e=>j(e.currentTarget.value)})]}})}}),r(g,{p:"$2",ref(e){"function"==typeof U?U(e):U=e},w:"$full",alignItems:"start",rounded:"$md",h:"70vh",bg:"$neutral3",overflowY:"auto",spacing:"$1",get children(){return r(m,{get each(){return O()},children:e=>r(w,e)})}})]}})};export{$ as default};
